<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <title>Talaria Media Message</title>
  <meta name="description" content="Talaria Media Message">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <meta name="theme-color" content="#fafafa">  
  <link href="https://vjs.zencdn.net/7.8.4/video-js.css" rel="stylesheet" />
  <script src="../client/v1/sylrtc-client.js"></script>
</head>
<body>

<style>
  .video-js {
    width: 100%;
    height: 480px;
  }

  .wrapper {
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    max-width: 640px;
    margin: 0 auto;
  }

  #title {
    margin: 30px 20px;
  }

  #info {
    font-size: 18px;
    padding: 0 20px;
    text-align: center;
    margin-bottom: 40px;
  }
</style>


<header>
  <img src="./talaria_logo.svg" alt="Talaria Logo" height="42">
  <h1>Media Message</h1>
</header>

<div class="wrapper">
  <div class="syl-card">
    <h2 id="title"></h2>
    <p id="info"></p>
  </div>
    
  <div class="syl-card">  
    <video    
      class="video-js"
      controls
      preload="auto"    
      data-setup="{}"
    >
      <p class="vjs-no-js">
        To view this video please enable JavaScript, and consider upgrading to a
        web browser that
        <a href="https://videojs.com/html5-video-support/" target="_blank"
          >supports HTML5 video</a
        >
      </p>
    </video>
  </div> 
</div>


<script lang="javascript">
function init(){
  var url_string = location.href;
  var url = new URL(url_string);
  var message_id = url.searchParams.get("message_id");
  console.log("message_id="+message_id);
  
  var base_url = location.protocol+ '//'+ location.host+ '/uploads/message-'+ message_id;

  var mp4_file_url = base_url+ '.' + 'mp4';
  var webm_file_url = base_url+ '.' +'webm';
  
  $('video').append('' + 
    '<source src="'+ mp4_file_url+ '" type="video/mp4" />' +
    '<source src="'+ webm_file_url+ '" type="video/webm" />'
  );
  
  $.get( "/api/av_message/", { message_id: message_id }, function(data, status, xhr) {
    console.log(data);
    if (data.error) {
      $('#info').html('Error: Invalid message id');
      $('#info').addClass('error');
        
    } else {
      var expiration_time= data.data.expiration_time;
      var sent_at = data.data.created_at;
      var title = data.data.title;
      var exp_localtime= new Date(data.data.expiration_time).toString().split(" GMT")[0];
      var sent_localtime= new Date(data.data.created_at).toString().split(" GMT")[0];
      if (title){
        $('#title').html(title);
        $ ('#info').html(data.data.sender_full_name+ ' recorded this at '+ sent_localtime+ ', and it will be available till '+ exp_localtime+ '.');
      }else{
        $('#title').html('Message from ' + data.data.sender_full_name);
        $('#info').html(data.data.sender_full_name+ ' recorded this meesage for you at '+ sent_localtime+ '. This message will be available till '+ exp_localtime+ '.');
      }
        
    }
  });
}

init();

</script>
<script src="https://vjs.zencdn.net/7.8.4/video.js"></script>
</body>

</html>
